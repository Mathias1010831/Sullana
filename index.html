<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Geoespacial del Agua en Sullana (Provincia)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { width: 100vw; height: 100vh; background-color: #f0f4f8; cursor: default; }
        #map.drawing-mode { cursor: crosshair; }
        
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background-color: #ffffff; transition: background-color 0.3s ease; }
        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.1); }
        .leaflet-popup-content { margin: 15px; font-size: 14px; line-height: 1.6; max-width: 320px !important; }
        .leaflet-popup-content h3, .leaflet-popup-content h4 { font-weight: 700; color: #111827; margin: 0 0 10px; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; transition: color 0.3s ease, border-color 0.3s ease; }
        .leaflet-popup-content p { margin: 5px 0; color: #374151; transition: color 0.3s ease; }
        .leaflet-popup-content p strong { color: #1f2937; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .interactive-panel {
            position: absolute; z-index: 1000;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        #legend { bottom: 20px; right: 20px; width: 210px; animation-delay: 0.2s; }
        #info-panel { bottom: 20px; left: 20px; width: 240px; animation-delay: 0.1s; }
        #drawing-tools { top: 20px; left: 20px; width: 240px; }

        .panel-header {
            padding: 10px 15px; font-weight: 600; text-align: center; font-size: 14px; color: #1f2937;
            cursor: move; user-select: none; position: relative;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .panel-content { 
            padding: 15px; line-height: 1.6; 
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, opacity 0.3s 0.1s ease-in-out;
            max-height: 500px; opacity: 1; overflow: hidden;
        }
        .panel-content.minimized { 
            max-height: 0; padding-top: 0; padding-bottom: 0; opacity: 0;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, opacity 0.2s ease-in-out;
        }
        .panel-toggle-btn { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; font-size: 24px; font-weight: bold; color: #9ca3af; padding: 0 5px; line-height: 1; transition: transform 0.4s ease; }
        .panel-toggle-btn.rotated { transform: translateY(-50%) rotate(135deg); }
        
        .legend-section div { display: flex; align-items: center; margin-bottom: 5px; font-size: 12px; }
        .legend-section strong { font-size: 13px; margin-bottom: 8px; display: block; }
        .legend-section span { width: 16px; height: 16px; margin-right: 8px; border-radius: 4px; }
        .marker-legend span { border-radius: 50%; }
        #info-panel p { margin: 6px 0; font-size: 13px; display: flex; justify-content: space-between; }
        #info-panel strong { font-weight: 600; color: #4b5563; }
        
        .district-label {
            background-color: transparent; border: none; box-shadow: none;
            color: #1a1a1a; font-weight: 600; font-size: 11px;
            text-shadow: 1px 1px 3px #fff, -1px -1px 3px #fff, 1px -1px 3px #fff, -1px 1px 3px #fff;
        }
        
        .leaflet-control-layers { border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: none; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); }
        .leaflet-control-layers-base label, .leaflet-control-layers-overlays label { font-weight: 600; color: #1f2937; }
        
        .drawing-controls { display: flex; flex-direction: column; gap: 10px; }
        .drawing-controls .control-row { display: flex; align-items: center; justify-content: space-between; }
        .color-palette { display: flex; gap: 8px; }
        .color-box { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-box:hover { transform: scale(1.1); }
        .color-box.active { border-color: #007bff; box-shadow: 0 0 0 2px white; }
        .tool-btn { background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; padding: 5px; cursor: pointer; }
        .tool-btn.active { background-color: #007bff; color: white; border-color: #007bff; }
        #brush-size { width: 100px; }

        body.dark-mode .leaflet-tile-pane { filter: none !important; }
        body.dark-mode .interactive-panel { background: rgba(29, 29, 31, 0.85); border-color: rgba(255, 255, 255, 0.1); }
        body.dark-mode .panel-header, body.dark-mode .legend-section div, body.dark-mode #info-panel p, body.dark-mode .legend-section strong, body.dark-mode .leaflet-popup-content h3, body.dark-mode .leaflet-popup-content h4 { color: #e5e7eb; }
        body.dark-mode #info-panel strong { color: #9ca3af; }
        body.dark-mode .panel-header { border-bottom-color: rgba(255,255,255,0.15); }
        body.dark-mode .panel-toggle-btn { color: #6b7280; }
        body.dark-mode .district-label { color: #f1f1f1; text-shadow: 1px 1px 3px #000, -1px -1px 3px #000, 1px -1px 3px #000, -1px 1px 3px #000; }
        body.dark-mode .leaflet-control-layers { background: rgba(29, 29, 31, 0.85); }
        body.dark-mode .leaflet-control-layers-base label, body.dark-mode .leaflet-control-layers-overlays label { color: #e5e7eb; }
        body.dark-mode .leaflet-popup-content-wrapper { background-color: #1d1d1f; border-color: rgba(255,255,255,0.1); }
        body.dark-mode .leaflet-popup-tip { background-color: #1d1d1f; }
        body.dark-mode .leaflet-popup-content p { color: #9ca3af; }
        body.dark-mode .tool-btn { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        body.dark-mode .tool-btn.active { background-color: #007bff; color: white; border-color: #007bff; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="drawing-tools" class="interactive-panel">
        <div class="panel-header">
            Herramientas de Dibujo
            <span class="panel-toggle-btn" title="Minimizar/Expandir">&minus;</span>
        </div>
        <div class="panel-content">
            <div class="drawing-controls">
                <div class="control-row">
                    <button id="toggle-draw" class="tool-btn" title="Activar/Desactivar Pincel">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.823.132a1.5 1.5 0 0 0-2.085 0l-8.459 8.459-1.07 3.758a.5.5 0 0 0 .616.616l3.758-1.07L15.823 2.218a1.5 1.5 0 0 0 0-2.086zM12.5 3.313l-1.87-1.87 6.363-6.363 1.87 1.87L12.5 3.313zm-1.68 2.553-4.42 4.42-1.92 1.92-.31.31 1.47 1.47.31-.31 1.92-1.92 4.42-4.42-1.47-1.47z"/></svg>
                    </button>
                    <div class="color-palette">
                        <div class="color-box active" style="background-color: #ffc107;" data-color="#ffc107"></div>
                        <div class="color-box" style="background-color: #dc3545;" data-color="#dc3545"></div>
                        <div class="color-box" style="background-color: #17a2b8;" data-color="#17a2b8"></div>
                        <div class="color-box" style="background-color: #28a745;" data-color="#28a745"></div>
                    </div>
                    <button id="clear-drawings" class="tool-btn" title="Borrar Dibujos">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg>
                    </button>
                </div>
                <div class="control-row">
                    <span>Grosor:</span>
                    <input type="range" id="brush-size" min="2" max="20" value="10">
                </div>
            </div>
        </div>
    </div>

    <div id="legend" class="interactive-panel">
        <div class="panel-header">Leyenda<span class="panel-toggle-btn" title="Minimizar/Expandir">&minus;</span></div>
        <div class="panel-content">
            <div class="legend-section marker-legend"><strong>Nivel de Servicio</strong>
                <div><span style="background-color: #28a745;"></span>Alto Nivel</div>
                <div><span style="background-color: #007bff;"></span>Nivel Central</div>
                <div><span style="background-color: #fd7e14;"></span>Nivel Crecimiento</div>
                <div><span style="background-color: #dc3545;"></span>Nivel Básico</div>
            </div>
            <hr class="my-2 border-gray-200 dark:border-gray-700">
            <div class="legend-section zone-legend"><strong>Zonas de Análisis</strong>
                <div><span style="background-color: #ffc107;"></span>Expansión</div>
                <div><span style="background-color: #17a2b8;"></span>Mejora Agrícola</div>
                <div><span style="background-color: #6f42c1;"></span>Mejora Urbana</div>
            </div>
        </div>
    </div>

    <div id="info-panel" class="interactive-panel">
        <div class="panel-header">Parámetros de Referencia<span class="panel-toggle-btn" title="Minimizar/Expandir">&minus;</span></div>
        <div class="panel-content">
            <p><strong>pH:</strong> <span>6.5 - 8.5</span></p>
            <p><strong>ppm (TDS):</strong> <span>&lt; 1000</span></p>
            <p><strong>µS/cm:</strong> <span>&lt; 1500</span></p>
            <p><strong>Coliformes Term.:</strong> <span>&lt; 0 NMP/100mL</span></p>
            <p class="mt-2 text-xs italic"><small>Fuente: D.S. N° 031-2010-SA</small></p>
        </div>
    </div>
    
    <script>
        const districtData = { "Sullana": { classification: { class: "Nivel Central" }, quality: { ph: 5.85, us/cm: 369 }, pop: { total: 162434, density: 333 }, coords: [-4.89008, -80.68740] }, "Bellavista": { classification: { class: "Nivel Central" }, quality: { ph: 7.5, tds: 290 }, pop: { total: 38200, density: 12733 }, coords: [-4.89021, -80.68078] }, "Marcavelica": { classification: { class: "Nivel de Crecimiento" }, quality: { ph: 7.4, tds: 320 }, pop: { total: 29538, density: 18 }, coords: [-4.88167, -80.70360] }, "Querecotillo": { classification: { class: "Nivel de Crecimiento" }, quality: { ph: 7.3, tds: 380 }, pop: { total: 26345, density: 97 }, coords: [-4.83997, -80.64903] }, "Salitral": { classification: { class: "Nivel de Crecimiento" }, quality: { ph: 7.2, tds: 350 }, pop: { total: 6300, density: 225 }, coords: [-4.85746, -80.68117] }, "Ignacio Escudero": { classification: { class: "Nivel Básico" }, quality: { ph: 7.1, tds: 400 }, pop: { total: 18454, density: 60 }, coords: [-4.84601, -80.87324] }, "Lancones": { classification: { class: "Nivel Básico" }, quality: { ph: 7.0, tds: 450 }, pop: { total: 13302, density: 6 }, coords: [-4.63278, -80.54560] }, "Miguel Checa": { classification: { class: "Nivel Básico" }, quality: { ph: 7.4, tds: 330 }, pop: { total: 8763, density: 20 }, coords: [-4.90217, -80.81542] } };
        const analysisZones = { "mejora_central_critica": { coords: [ [-4.88, -80.69], [-4.895, -80.685], [-4.89, -80.675], [-4.875, -80.68] ], color: "#6f42c1", title: "Mejora Crítica (Centro Urbano)" }, "expansion_urbana": { coords: [ [-4.87, -80.71], [-4.88, -80.715], [-4.885, -80.70], [-4.875, -80.695] ], color: "#ffc107", title: "Expansión Prioritaria (Urbana)" }, "mejora_agricola": { coords: [ [-4.83, -80.66], [-4.84, -80.655], [-4.845, -80.64], [-4.835, -80.645] ], color: "#17a2b8", title: "Mejora de Red (Valle Agrícola)" }, "expansion_poechos": { coords: [ [-4.62, -80.55], [-4.63, -80.56], [-4.64, -80.54], [-4.63, -80.53] ], color: "#ffc107", title: "Expansión Prioritaria (Eje Lancones)" } };
        const classificationColorMapping = { "Alto Nivel": "#28a745", "Nivel Central": "#007bff", "Nivel de Crecimiento": "#fd7e14", "Nivel Básico": "#dc3545" };

       
        function toDMS(coord, type) {
            const absolute = Math.abs(coord);
            const degrees = Math.floor(absolute);
            const minutesNotTruncated = (absolute - degrees) * 60;
            const minutes = Math.floor(minutesNotTruncated);
            const seconds = Math.floor((minutesNotTruncated - minutes) * 60);
            const direction = type === 'lat' ? (coord < 0 ? 'S' : 'N') : (coord < 0 ? 'O' : 'E');
            return `${degrees}°${minutes}′${seconds}″${direction}`;
        }

        const southWest = L.latLng(-5.1, -81.0); const northEast = L.latLng(-4.1, -80.4); const bounds = L.latLngBounds(southWest, northEast);
        const map = L.map('map', { center: [-4.8, -80.7], zoom: 10, maxBounds: bounds, minZoom: 9 });

        const baseLayers = {
            "Claro": L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }),
            "Oscuro": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', className: 'leaflet-layer-dark' }),
            "Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri', className: 'leaflet-layer-satelite' })
        };
        baseLayers["Claro"].addTo(map);

        const districtMarkersLayer = L.layerGroup();
        const districtLabelsLayer = L.layerGroup();
        const zoneLayer = L.layerGroup();
        const drawingLayer = L.layerGroup();
        
        for (const zoneKey in analysisZones) { L.polygon(analysisZones[zoneKey].coords, { color: analysisZones[zoneKey].color, fillColor: analysisZones[zoneKey].color, fillOpacity: 0.3, weight: 2 }).bindPopup(`<h4>${analysisZones[zoneKey].title}</h4>`).addTo(zoneLayer); }
        for (const district in districtData) {
            const data = districtData[district]; const coords = data.coords;
            const markerColor = classificationColorMapping[data.classification.class];
            const dmsLat = toDMS(coords[0], 'lat'); const dmsLng = toDMS(coords[1], 'lng');
            const popupContent = `<h3>${district}</h3><p class="text-xs"><strong>Coordenadas:</strong> ${dmsLat}, ${dmsLng}</p><p><strong>Nivel de Servicio:</strong> <span style="color: ${markerColor}; font-weight: bold;">${data.classification.class}</span></p><hr style="margin: 10px 0;"><h4>Datos Demográficos y Calidad</h4><p><strong>Población (2017):</strong> ${data.pop.total.toLocaleString('es-PE')}</p><p><strong>Densidad Pobl.:</strong> ${data.pop.density.toLocaleString('es-PE')} Hab/km²</p><p><strong>pH (Est.):</strong> ${data.quality.ph}</p><p><strong>ppm (Est.):</strong> ${data.quality.tds}</p>`;
            L.circleMarker(coords, { radius: 7, fillColor: markerColor, color: '#333', weight: 1.5, opacity: 1, fillOpacity: 0.9 }).bindPopup(popupContent).addTo(districtMarkersLayer);
            L.tooltip(coords, { content: district, permanent: true, direction: 'top', offset: [0, -10], className: 'district-label' }).addTo(districtLabelsLayer);
        }
        
        const overlayMaps = { "Zonas de Análisis": zoneLayer, "Distritos (Servicio)": districtMarkersLayer, "Nombres de Distritos": districtLabelsLayer, "Mis Dibujos": drawingLayer };
        zoneLayer.addTo(map); districtMarkersLayer.addTo(map); districtLabelsLayer.addTo(map); drawingLayer.addTo(map);
        
        const layersControl = L.control.layers(baseLayers, overlayMaps, { position: 'topright', collapsed: true }).addTo(map);
        const layersContainer = layersControl.getContainer();
        L.DomEvent.disableClickPropagation(layersContainer);
        L.DomEvent.on(layersContainer, 'mousewheel', L.DomEvent.stopPropagation);
        layersContainer.querySelector('.leaflet-control-layers-toggle').addEventListener('click', (e) => {
            L.DomEvent.stopPropagation(e);
            if (L.DomUtil.hasClass(layersContainer, 'leaflet-control-layers-expanded')) { layersControl.collapse(); } else { layersControl.expand(); }
        });
        map.on('click', () => { if (L.DomUtil.hasClass(layersContainer, 'leaflet-control-layers-expanded')) { layersControl.collapse(); }});

        map.on('baselayerchange', function(e) { 
            document.body.classList.toggle('dark-mode', e.name === 'Oscuro');
        });
        document.body.classList.remove('dark-mode');

        // --- LÓGICA DE DIBUJO ---
        const drawToggleBtn = document.getElementById('toggle-draw');
        const brushSizeSlider = document.getElementById('brush-size');
        const colorPalette = document.querySelector('.color-palette');
        const clearDrawingsBtn = document.getElementById('clear-drawings');

        let isDrawing = false;
        let isDrawMode = false;
        let currentLine = null;
        let currentColor = '#ffc107';
        let currentWeight = 10;

        drawToggleBtn.addEventListener('click', () => {
            isDrawMode = !isDrawMode;
            map.getContainer().classList.toggle('drawing-mode');
            drawToggleBtn.classList.toggle('active');
        });

        colorPalette.addEventListener('click', (e) => {
            if (e.target.classList.contains('color-box')) {
                currentColor = e.target.dataset.color;
                document.querySelector('.color-box.active').classList.remove('active');
                e.target.classList.add('active');
            }
        });

        brushSizeSlider.addEventListener('input', (e) => { currentWeight = e.target.value; });
        clearDrawingsBtn.addEventListener('click', () => drawingLayer.clearLayers());

        map.on('mousedown', (e) => {
            if (!isDrawMode) return;
            isDrawing = true;
            map.dragging.disable();
            currentLine = L.polyline([e.latlng], {
                color: currentColor,
                weight: currentWeight,
                opacity: 0.6,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(drawingLayer);
        });

        map.on('mousemove', (e) => {
            if (!isDrawMode || !isDrawing || !currentLine) return;
            currentLine.addLatLng(e.latlng);
        });

        map.on('mouseup mouseout', () => {
            isDrawing = false;
            currentLine = null;
            map.dragging.enable();
        });

        function makePanelInteractive(panelId) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            const header = panel.querySelector('.panel-header');
            const content = panel.querySelector('.panel-content');
            const toggleBtn = panel.querySelector('.panel-toggle-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isMinimized = content.classList.toggle('minimized');
                    toggleBtn.classList.toggle('rotated', isMinimized);
                    toggleBtn.innerHTML = isMinimized ? '&#43;' : '&minus;';
                });
            }

            let isDragging = false, offsetX, offsetY;
            (header || panel).addEventListener('mousedown', (e) => {
                if (e.target.closest('button, .panel-toggle-btn, input, .color-palette')) return;
                isDragging = true;
                const rect = panel.getBoundingClientRect();
                offsetX = e.clientX - rect.left; offsetY = e.clientY - rect.top;
                panel.style.right = 'auto'; panel.style.bottom = 'auto';
                panel.style.left = `${rect.left}px`; panel.style.top = `${rect.top}px`;
                panel.style.transition = 'none'; document.body.style.userSelect = 'none';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                panel.style.left = `${e.clientX - offsetX}px`;
                panel.style.top = `${e.clientY - offsetY}px`;
            });
            document.addEventListener('mouseup', () => {
                if (!isDragging) return;
                isDragging = false;
                panel.style.transition = ''; document.body.style.userSelect = 'auto';
            });
        }
        makePanelInteractive('legend');
        makePanelInteractive('info-panel');
        makePanelInteractive('drawing-tools');
    </script>
</body>
</html>